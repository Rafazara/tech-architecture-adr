# =============================================================================
# ADR Validation Workflow
# =============================================================================
# Enterprise-grade CI/CD validation for Architecture Decision Records.
# Ensures structural compliance, metadata integrity, and governance adherence.
#
# Validation Scope:
#   - Structural validation (required sections present)
#   - Naming convention enforcement (NNNN-slug.md format)
#   - Metadata completeness checks
#   - Immutability protection (accepted ADRs cannot be modified)
#   - Supersession chain validation
#
# References:
#   - Michael Nygard ADR Standard: https://cognitect.com/blog/2011/11/15/documenting-architecture-decisions
#   - ThoughtWorks Tech Radar: https://www.thoughtworks.com/radar/techniques/lightweight-architecture-decision-records
#
# Maintainer: Architecture Governance Team
# =============================================================================

name: ADR Validation

on:
  pull_request:
    paths:
      - "docs/adr/**"
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
    paths:
      - "docs/adr/**"

# Prevent concurrent runs on same PR to avoid race conditions
concurrency:
  group: adr-validation-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

env:
  ADR_PATH: docs/adr
  TEMPLATE_FILE: 0000-template.md

jobs:
  # ===========================================================================
  # Job: Structural Validation
  # ===========================================================================
  # Validates that all ADR files conform to required structure and naming.
  # ===========================================================================
  structural-validation:
    name: Structural Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for diff analysis

      # -----------------------------------------------------------------------
      # Step: Validate Naming Convention
      # -----------------------------------------------------------------------
      # Ensures all ADR files follow NNNN-descriptive-slug.md format.
      # Template (0000-template.md) and README.md are excluded.
      # -----------------------------------------------------------------------
      - name: Validate ADR Naming Convention
        run: |
          echo "========================================"
          echo "ADR Naming Convention Validation"
          echo "========================================"

          ERRORS=0

          for file in ${{ env.ADR_PATH }}/*.md; do
            filename=$(basename "$file")
            
            # Skip template and README
            if [[ "$filename" == "0000-template.md" ]] || [[ "$filename" == "README.md" ]]; then
              echo "✓ Skipping: $filename (excluded from validation)"
              continue
            fi
            
            # Validate format: NNNN-descriptive-slug.md
            if [[ ! "$filename" =~ ^[0-9]{4}-[a-z0-9]+(-[a-z0-9]+)*\.md$ ]]; then
              echo "✗ ERROR: Invalid naming format: $filename"
              echo "  Expected: NNNN-descriptive-slug.md (e.g., 0001-adopt-adrs.md)"
              echo "  Rules: 4-digit prefix, lowercase, hyphens only, no underscores"
              ERRORS=$((ERRORS + 1))
            else
              echo "✓ Valid: $filename"
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "========================================"
            echo "FAILED: $ERRORS naming violation(s) found"
            echo "========================================"
            exit 1
          fi

          echo ""
          echo "========================================"
          echo "PASSED: All ADR files follow naming convention"
          echo "========================================"

      # -----------------------------------------------------------------------
      # Step: Validate Required Sections
      # -----------------------------------------------------------------------
      # Ensures all ADR files contain mandatory sections per template.
      # Critical sections are validated with exact header matching.
      # -----------------------------------------------------------------------
      - name: Validate Required Sections
        run: |
          echo "========================================"
          echo "ADR Required Sections Validation"
          echo "========================================"

          # Define required sections (must exist in every ADR)
          REQUIRED_SECTIONS=(
            "## Metadata"
            "## Context"
            "## Decision"
            "## Consequences"
          )

          # Define recommended sections (warn if missing)
          RECOMMENDED_SECTIONS=(
            "## Problem Statement"
            "## Decision Drivers"
            "## Options Considered"
            "## Rationale"
          )

          ERRORS=0
          WARNINGS=0

          for file in ${{ env.ADR_PATH }}/*.md; do
            filename=$(basename "$file")
            
            # Skip template and README
            if [[ "$filename" == "0000-template.md" ]] || [[ "$filename" == "README.md" ]]; then
              continue
            fi
            
            echo ""
            echo "----------------------------------------"
            echo "Validating: $filename"
            echo "----------------------------------------"
            
            # Check required sections
            for section in "${REQUIRED_SECTIONS[@]}"; do
              if ! grep -q "^${section}" "$file"; then
                echo "✗ ERROR: Missing required section: $section"
                ERRORS=$((ERRORS + 1))
              else
                echo "✓ Found: $section"
              fi
            done
            
            # Check recommended sections (warnings only)
            for section in "${RECOMMENDED_SECTIONS[@]}"; do
              if ! grep -q "^${section}" "$file"; then
                echo "⚠ WARNING: Missing recommended section: $section"
                WARNINGS=$((WARNINGS + 1))
              fi
            done
          done

          echo ""
          echo "========================================"
          echo "Validation Summary"
          echo "========================================"
          echo "Errors: $ERRORS"
          echo "Warnings: $WARNINGS"

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "FAILED: $ERRORS required section(s) missing"
            exit 1
          fi

          echo ""
          echo "PASSED: All required sections present"
          if [ $WARNINGS -gt 0 ]; then
            echo "Note: $WARNINGS recommended section(s) missing"
          fi

      # -----------------------------------------------------------------------
      # Step: Validate Metadata Fields
      # -----------------------------------------------------------------------
      # Ensures ADR metadata contains all required fields.
      # -----------------------------------------------------------------------
      - name: Validate Metadata Fields
        run: |
          echo "========================================"
          echo "ADR Metadata Validation"
          echo "========================================"

          REQUIRED_METADATA=(
            "ADR ID:"
            "Status:"
            "Date:"
            "Author:"
          )

          VALID_STATUSES=("Proposed" "Accepted" "Superseded" "Discontinued" "Rejected")

          ERRORS=0

          for file in ${{ env.ADR_PATH }}/*.md; do
            filename=$(basename "$file")
            
            # Skip template and README
            if [[ "$filename" == "0000-template.md" ]] || [[ "$filename" == "README.md" ]]; then
              continue
            fi
            
            echo ""
            echo "----------------------------------------"
            echo "Validating metadata: $filename"
            echo "----------------------------------------"
            
            # Check required metadata fields
            for field in "${REQUIRED_METADATA[@]}"; do
              if ! grep -q "$field" "$file"; then
                echo "✗ ERROR: Missing metadata field: $field"
                ERRORS=$((ERRORS + 1))
              else
                echo "✓ Found: $field"
              fi
            done
            
            # Validate status value
            STATUS_LINE=$(grep "Status:" "$file" | head -1)
            VALID=0
            for status in "${VALID_STATUSES[@]}"; do
              if [[ "$STATUS_LINE" == *"$status"* ]]; then
                VALID=1
                echo "✓ Valid status: $status"
                break
              fi
            done
            
            if [ $VALID -eq 0 ]; then
              echo "✗ ERROR: Invalid status value in: $STATUS_LINE"
              echo "  Allowed values: ${VALID_STATUSES[*]}"
              ERRORS=$((ERRORS + 1))
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "========================================"
            echo "FAILED: $ERRORS metadata error(s) found"
            echo "========================================"
            exit 1
          fi

          echo ""
          echo "========================================"
          echo "PASSED: All metadata fields valid"
          echo "========================================"

  # ===========================================================================
  # Job: Immutability Protection
  # ===========================================================================
  # Prevents modification of ADRs with Accepted status.
  # Only runs on pull requests to detect unauthorized changes.
  # ===========================================================================
  immutability-check:
    name: Immutability Protection
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Accepted ADR Modifications
        run: |
          echo "========================================"
          echo "ADR Immutability Check"
          echo "========================================"
          echo ""
          echo "Principle: Accepted ADRs are immutable."
          echo "Modifications require a new ADR that supersedes the original."
          echo ""

          # Get list of modified ADR files in this PR
          MODIFIED_FILES=$(git diff --name-only origin/main...HEAD -- '${{ env.ADR_PATH }}/*.md' 2>/dev/null || echo "")

          if [ -z "$MODIFIED_FILES" ]; then
            echo "No ADR files modified in this PR."
            echo "PASSED: Immutability check complete"
            exit 0
          fi

          VIOLATIONS=0

          for file in $MODIFIED_FILES; do
            filename=$(basename "$file")
            
            # Skip template, README, and new files
            if [[ "$filename" == "0000-template.md" ]] || [[ "$filename" == "README.md" ]]; then
              continue
            fi
            
            # Check if file existed before (not a new ADR)
            if git show origin/main:"$file" &>/dev/null; then
              # Get status from main branch version
              MAIN_STATUS=$(git show origin/main:"$file" | grep "Status:" | head -1 || echo "")
              
              if [[ "$MAIN_STATUS" == *"Accepted"* ]]; then
                echo "✗ VIOLATION: Attempt to modify accepted ADR: $filename"
                echo "  Accepted ADRs are immutable per governance policy."
                echo "  To change this decision, create a new ADR that supersedes ADR-${filename:0:4}."
                VIOLATIONS=$((VIOLATIONS + 1))
              else
                echo "✓ OK: $filename (Status is not 'Accepted', modification allowed)"
              fi
            else
              echo "✓ OK: $filename (New ADR, no immutability constraint)"
            fi
          done

          if [ $VIOLATIONS -gt 0 ]; then
            echo ""
            echo "========================================"
            echo "FAILED: $VIOLATIONS immutability violation(s)"
            echo "========================================"
            echo ""
            echo "Resolution:"
            echo "1. Revert changes to accepted ADR(s)"
            echo "2. Create a new ADR proposing the change"
            echo "3. Reference the original ADR in 'Supersedes' field"
            exit 1
          fi

          echo ""
          echo "========================================"
          echo "PASSED: No immutability violations"
          echo "========================================"

  # ===========================================================================
  # Job: Supersession Chain Validation
  # ===========================================================================
  # Validates that supersession references are valid and bidirectional.
  # ===========================================================================
  supersession-validation:
    name: Supersession Chain Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Validate Supersession References
        run: |
          echo "========================================"
          echo "ADR Supersession Chain Validation"
          echo "========================================"

          ERRORS=0

          for file in ${{ env.ADR_PATH }}/*.md; do
            filename=$(basename "$file")
            
            # Skip template and README
            if [[ "$filename" == "0000-template.md" ]] || [[ "$filename" == "README.md" ]]; then
              continue
            fi
            
            # Check if this ADR supersedes another
            SUPERSEDES=$(grep -i "Supersedes:" "$file" | head -1 || echo "")
            
            if [ -n "$SUPERSEDES" ]; then
              # Extract referenced ADR ID (format: ADR-NNNN or NNNN)
              REF_ID=$(echo "$SUPERSEDES" | grep -oE '[0-9]{4}' | head -1)
              
              if [ -n "$REF_ID" ]; then
                # Find the referenced ADR file
                REF_FILE=$(find ${{ env.ADR_PATH }} -name "${REF_ID}-*.md" | head -1)
                
                if [ -z "$REF_FILE" ]; then
                  echo "✗ ERROR: $filename supersedes ADR-$REF_ID but that ADR does not exist"
                  ERRORS=$((ERRORS + 1))
                else
                  # Check if referenced ADR has status Superseded
                  REF_STATUS=$(grep "Status:" "$REF_FILE" | head -1 || echo "")
                  
                  if [[ "$REF_STATUS" != *"Superseded"* ]]; then
                    echo "⚠ WARNING: $filename supersedes ADR-$REF_ID but $REF_ID status is not 'Superseded'"
                    echo "  Consider updating $(basename "$REF_FILE") status to 'Superseded'"
                  else
                    echo "✓ Valid supersession: $filename → ADR-$REF_ID"
                  fi
                fi
              fi
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "========================================"
            echo "FAILED: $ERRORS supersession error(s)"
            echo "========================================"
            exit 1
          fi

          echo ""
          echo "========================================"
          echo "PASSED: Supersession chains valid"
          echo "========================================"

  # ===========================================================================
  # Job: ADR Index Generation (Optional)
  # ===========================================================================
  # Generates or updates the ADR index in README.md.
  # Only runs on push to main (after PR merge).
  # ===========================================================================
  generate-index:
    name: Generate ADR Index
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [structural-validation, supersession-validation]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Generate ADR Summary
        run: |
          echo "========================================"
          echo "ADR Repository Summary"
          echo "========================================"

          TOTAL=0
          PROPOSED=0
          ACCEPTED=0
          SUPERSEDED=0
          DISCONTINUED=0
          REJECTED=0

          for file in ${{ env.ADR_PATH }}/*.md; do
            filename=$(basename "$file")
            
            # Skip template and README
            if [[ "$filename" == "0000-template.md" ]] || [[ "$filename" == "README.md" ]]; then
              continue
            fi
            
            TOTAL=$((TOTAL + 1))
            STATUS=$(grep "Status:" "$file" | head -1 || echo "")
            
            case "$STATUS" in
              *"Proposed"*) PROPOSED=$((PROPOSED + 1)) ;;
              *"Accepted"*) ACCEPTED=$((ACCEPTED + 1)) ;;
              *"Superseded"*) SUPERSEDED=$((SUPERSEDED + 1)) ;;
              *"Discontinued"*) DISCONTINUED=$((DISCONTINUED + 1)) ;;
              *"Rejected"*) REJECTED=$((REJECTED + 1)) ;;
            esac
          done

          echo ""
          echo "Total ADRs: $TOTAL"
          echo "├── Proposed: $PROPOSED"
          echo "├── Accepted: $ACCEPTED"
          echo "├── Superseded: $SUPERSEDED"
          echo "├── Discontinued: $DISCONTINUED"
          echo "└── Rejected: $REJECTED"
          echo ""
          echo "========================================"
